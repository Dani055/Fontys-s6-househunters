<!DOCTYPE html> <html> <body> <p>The deploy stage of the CI/CD pipeline deals deploying the application to a GCloud Kubernetes cluster.</p><p><img src="https://portfolio.drieam.app/api/public/v1/blobs/545ea1b8-b9c6-4fdf-9e1d-cab50ed05fbf/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaHBBMXV6QXc9PSIsImV4cCI6bnVsbCwicHVyIjoiYmxvYl9pZCJ9fQ==--9a147e5fcdf8a5151116ab39437215ec6e4fe132/image_2024-05-25_224939822.png" data-key="72u0nri71txrls7fpynrxqu51bzi"></p><p>This stage only runs on the main branch, as it is unneeded in other branches and review environment are not implemented, since they are overkill for a one-man operation like the individual project.</p><p>The code for deploying the application in the gitlab CI definition file is as follows:</p><pre><code>deploy_k8s_production: stage: deploy_prod rules: - if: $CI_COMMIT_BRANCH == "main" image: gcr.io/google.com/cloudsdktool/google-cloud-cli:latest script: - gcloud auth activate-service-account --key-file "$GCLOUD_KEY" - gcloud container clusters get-credentials househunters-cluster-1 --project=househunters-423407 --location=europe-west1 - kubectl config set-context --current --namespace=househunters - cd kubernetes - kubectl apply -f message-broker.yaml -f auth-ms.yaml -f listing-ms.yaml -f bid-ms.yaml -f media-ms.yaml -f frontend.yaml -f ingress-gce.yaml</code></pre><p>It uses the the gcloud cli docker image to take leverage of the fact that the gcloud cli and kubectl are already installed. All that needs to be done is to authenticate the job with a low-privilege service account and the kubernetes files can be applied declaratively, deploying the application.</p> </body> </html>